---
title: "Simulação Completa (EC03) - Equipe F (Custom)"
author: "Equipe F"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: pdf_document
---

# Simulação e Geração de Dados

O código abaixo executa a simulação com as configurações manuais fornecidas pela Equipe F.

```{r simulacao_completa, echo=TRUE}
# ==============================================================================
# 1. SETUP INICIAL E PACOTES
# ==============================================================================
knitr::opts_chunk$set(echo = TRUE)
options(repos = c(CRAN = "[https://cloud.r-project.org](https://cloud.r-project.org)"))

pkgs <- c("ExpDE", "smoof", "pwr")
for(pkg in pkgs){
  if(!requireNamespace(pkg, quietly = TRUE)) install.packages(pkg)
  library(pkg, character.only = TRUE)
}
set.seed(12345)

# ==============================================================================
# 2. DEFINIÇÃO DE PARÂMETROS
# ==============================================================================
N_REPETICOES <- 15
EFFECT_SIZE  <- 0.5
POWER        <- 0.8
ALPHA        <- 0.05

# --- CONFIGURAÇÕES DA EQUIPE F (MANUAL) ---

# Config 1 (Estática - não depende de D)
recpars1 <- list(name = "recombination_mmax", lambda = 0.25)
mutpars1 <- list(name = "mutation_best", f = 4)

# Config 2 (Parte da mutação é estática)
mutpars2 <- list(name = "mutation_rand", f = 2.2)
# NOTA: recpars2 depende de 'dim', então será definido dentro do loop.

selpars  <- list(name = "selection_standard")

# ==============================================================================
# 3. PLANEJAMENTO
# ==============================================================================
pwr_res <- pwr.t.test(d = EFFECT_SIZE, sig.level = ALPHA, power = POWER,
                      type = "paired", alternative = "two.sided")
N_blocos <- (ceiling(pwr_res$n))
dims_teste <- sort(sample(2:150, N_blocos, replace = FALSE))

message("=== INÍCIO DA SIMULAÇÃO (EQUIPE F - CUSTOM) ===")
message(paste("Dimensões:", paste(dims_teste, collapse=", ")))

dados_sim <- data.frame(dim = integer(N_blocos),
                        Fbest_media_cfg1 = numeric(N_blocos),
                        Fbest_media_cfg2 = numeric(N_blocos))

# ==============================================================================
# 4. LOOP DE EXECUÇÃO
# ==============================================================================
pb <- txtProgressBar(min = 0, max = N_blocos, style = 3)

for (i in 1:N_blocos) {
  D <- dims_teste[i]
  
  # --- DEFINIÇÃO DINÂMICA PARA CONFIG 2 ---
  # Como solicitado: N = dim / 2. Usamos floor() para garantir número inteiro.
  # Garante que N seja pelo menos 1 mesmo se D=2 ou 3.
  n_points <- max(1, floor(D / 2))
  recpars2 <- list(name = "recombination_npoint", N = n_points)

  # Setup do problema
  smoof_fn <- makeRosenbrockFunction(dimensions = D)
  fn_wrap <- function(X) {
    if(!is.matrix(X)) X <- matrix(X, nrow=1)
    apply(X, 1, smoof_fn)
  }

  probpars <- list(name = "fn_wrap", xmin = rep(-5, D), xmax = rep(10, D))
  stopcrit <- list(names = "stop_maxeval", maxevals = 5000 * D)
  pop_sz   <- 5 * D # Assumindo população 5D padrão se não foi especificado diferente

  reps_c1 <- numeric(N_REPETICOES)
  reps_c2 <- numeric(N_REPETICOES)

  for (j in 1:N_REPETICOES) {
    # Cfg1
    invisible(capture.output({
      out1 <- ExpDE(mutpars=mutpars1, recpars=recpars1, popsize=pop_sz, selpars=selpars,
                    stopcrit=stopcrit, probpars=probpars, showpars=list(show.iters="none"))
    }))
    reps_c1[j] <- out1$Fbest

    # Cfg2 (Usando o recpars2 dinâmico definido acima)
    invisible(capture.output({
      out2 <- ExpDE(mutpars=mutpars2, recpars=recpars2, popsize=pop_sz, selpars=selpars,
                    stopcrit=stopcrit, probpars=probpars, showpars=list(show.iters="none"))
    }))
    reps_c2[j] <- out2$Fbest
  }

  dados_sim$dim[i] <- D
  dados_sim$Fbest_media_cfg1[i] <- mean(reps_c1)
  dados_sim$Fbest_media_cfg2[i] <- mean(reps_c2)
  setTxtProgressBar(pb, i)
}
close(pb)

# ==============================================================================
# 5. SALVAR RESULTADOS
# ==============================================================================
write.csv(dados_sim, "dados_EC03_EquipeF_N.csv", row.names = FALSE)
message(">>> SIMULAÇÃO CONCLUÍDA! Dados salvos. <<<")
